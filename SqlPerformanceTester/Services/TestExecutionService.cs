using System.Collections.Concurrent;
using System.Data.SqlClient;
using System.Diagnostics;
using System.Text.RegularExpressions;
using SqlPerformanceTester.Models;
using SqlPerformanceTester.Services.Interfaces;

namespace SqlPerformanceTester.Services;

public class TestExecutionService : ITestExecutionService
{
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” CODE REVIEW: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //
    // ğŸ“ Ğ¢Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ»:
    //    "Ğ£ Ğ¼ĞµĞ½Ñ Ğ½Ğ° Ğ¾Ğ´Ğ½Ñƒ Ğ‘Ğ” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ connection"
    //    "Ğ¯ Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ Task.WhenAll"
    //    "Ğ¯ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Ñ†Ğ¸ĞºĞ» Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°ÑÑÑŒ Ğº Ğ‘Ğ”"
    //
    // ğŸ¤” Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼, Ñ‚Ğ°Ğº Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğ° ÑĞ°Ğ¼Ğ¾Ğ¼ Ğ´ĞµĞ»Ğµ:
    //
    // â“ Ğ“Ğ´Ğµ Ğ² ĞºĞ¾Ğ´Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ SqlConnection?
    // â“ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ¾Ğ½ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ?
    // â“ Ğ•ÑÑ‚ÑŒ Ğ»Ğ¸ Ğ² ĞºĞ¾Ğ´Ğµ Task.WhenAll? (Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñƒ: Ctrl+F)
    // â“ Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ° Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¸Ğ´Ñ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾?
    //
    // ğŸ’­ ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ÑÑŒ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹.
    // ğŸ’­ ĞœĞ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ, Ñ‚Ğ²Ğ¾Ñ‘ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚?
    //
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public async Task<IReadOnlyCollection<TestResult>> RunLoadTestAsync(
        TestConfiguration config,
        Action<string> updateCountdown,
        CancellationToken cancellationToken)
    {
        var results = new ConcurrentBag<TestResult>();
        int maxAccountIdValue = GetMaxPercentMarkerValue(config.Query);

        var connectionString =
            $"Server={config.Server};Database={config.Database};Integrated Security=true;TrustServerCertificate=true;";

        await TestConnectionAsync(connectionString, cancellationToken);

        var testEndTime = DateTime.UtcNow.AddSeconds(config.TestDuration);
        var tasks = new List<Task>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¤” Ğ’ĞĞŸĞ ĞĞ¡Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ—ĞœĞ«Ğ¨Ğ›Ğ•ĞĞ˜Ğ¯:
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //
        // â“ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑÑ ÑÑ‚Ğ¾Ñ‚ Ñ†Ğ¸ĞºĞ» for?
        // â“ Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Task.Run? ĞšĞ¾Ğ³Ğ´Ğ° Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°?
        // â“ Ğ¦Ğ¸ĞºĞ» ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾... Ğ° ĞºĞ°Ğº Ğ¾Ğ½Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚ÑÑ?
        //
        // ğŸ’­ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ: ĞµÑĞ»Ğ¸ threadsCount = 10, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Task.Run Ğ²Ñ‹Ğ·Ğ¾Ğ²ĞµÑ‚ÑÑ?
        // ğŸ’­ Ğ’ÑĞµ ÑÑ‚Ğ¸ Task.Run Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ - Ğ¾Ğ½Ğ¸ Ğ¶Ğ´ÑƒÑ‚ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ğ° Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚?
        //
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        for (int threadIndex = 0; threadIndex < config.ThreadsCount; threadIndex++)
        {
            var threadId = threadIndex + 1;

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ£Ğ±Ñ€Ğ°Ğ½ Ğ¸Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Task.Run
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            //
            // Task.Run Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ I/O-bound Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ (async/await)
            // Async Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ ÑƒĞ¶Ğµ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹ Ğ¸ Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸
            // ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² async Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ° ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½ĞµĞµ - Ğ½ĞµÑ‚ overhead ThreadPool
            //
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            var task = ExecuteThreadWorkAsync(
                connectionString,
                config.Query,
                testEndTime,
                maxAccountIdValue,
                threadId,
                results,
                cancellationToken);

            tasks.Add(task);
        }

        // â“ Ğ ÑÑ‚Ğ¾ Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚?
        // â“ Ğ¢Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ», Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ Ğ½ĞµÑ‚ Task.WhenAll... Ğ° Ñ‡Ñ‚Ğ¾ Ñ‚Ğ¾Ğ³Ğ´Ğ° Ğ·Ğ´ĞµÑÑŒ?
        // ğŸ’­ Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ½ÑƒĞ¶ĞµĞ½ WhenAll, ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸ Ñ‚Ğ°Ğº ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹ Ğ²Ñ‹ÑˆĞµ?
        // ğŸ’­ Ğ§Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚, ĞµÑĞ»Ğ¸ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ?
        //
        // ğŸ¤” Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Task.WhenAll... Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Task...
        // ğŸ¤” Ğ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Task... ĞºĞ°Ğº Ğ¾Ğ½Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ğ°?
        await Task.WhenAll(tasks);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¯ Ğ˜Ğ¢ĞĞ“ĞĞ’Ğ«Ğ• Ğ’ĞĞŸĞ ĞĞ¡Ğ«:
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //
        // â“ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞ»Ğ¾ÑÑŒ ĞĞ”ĞĞĞ’Ğ Ğ•ĞœĞ•ĞĞĞ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…?
        // â“ Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ğ» 50 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ², ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ connections Ğ±Ñ‹Ğ»Ğ¾ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾?
        // â“ Ğ­Ñ‚Ğ¾ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾?
        //
        // ğŸ¤” ĞŸĞ¾Ğ´ÑƒĞ¼Ğ°Ğ¹ Ğ¿Ñ€Ğ¾ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹:
        // â“ ĞœĞ¾Ğ³ Ğ±Ñ‹ Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ SemaphoreSlim? Ğ—Ğ°Ñ‡ĞµĞ¼? Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ´Ğ°Ñ‘Ñ‚?
        // ğŸ’­ SemaphoreSlim Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ĞšĞĞ›Ğ˜Ğ§Ğ•Ğ¡Ğ¢Ğ’Ğ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
        // ğŸ’­ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ñƒ Ñ‚ĞµĞ±Ñ threadsCount Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ’Ğ¡Ğ• Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
        // ğŸ’­ ĞÑƒĞ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ? Ğ˜Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ?
        //
        // â“ Ğ TaskScheduler? Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ¾Ğ½ Ğ½ÑƒĞ¶ĞµĞ½?
        // ğŸ’­ TaskScheduler ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞšĞĞš Ğ¸ Ğ“Ğ”Ğ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚ÑÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        // ğŸ’­ ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ThreadPool
        // ğŸ’­ ĞÑƒĞ¶ĞµĞ½ Ğ»Ğ¸ Ñ‚ĞµĞ±Ğµ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ·Ğ´ĞµÑÑŒ?
        //
        // ğŸ¤” Ğ Ñ‡Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Task.Run Ğ¸ Ğ²Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ async Ğ¼ĞµÑ‚Ğ¾Ğ´?
        // ğŸ’­ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ?
        // ğŸ’­ Ğ¡Ñ‚Ğ°Ğ½ĞµÑ‚ Ğ»Ğ¸ ĞºĞ¾Ğ´ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ/Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½ĞµĞµ?
        //
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        return results;
    }

    private static async Task TestConnectionAsync(string connectionString, CancellationToken cancellationToken)
    {
        await using var connection = new SqlConnection(connectionString);
        await connection.OpenAsync(cancellationToken);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¤” Ğ’ĞĞŸĞ ĞĞ¡Ğ« ĞŸĞ Ğ ExecuteQueryAsync:
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //
    // â“ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ connection ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€... Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¾Ğ½ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚?
    // â“ Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾?
    // ğŸ’­ Ğ•ÑĞ»Ğ¸ Ñƒ Ğ¼ĞµĞ½Ñ 10 Task, Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ°Ñ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´...
    // ğŸ’­ ĞœĞ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Task?
    //
    // â“ Ğ ĞµÑĞ»Ğ¸ Ğ´Ğ²Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ ĞĞ”Ğ˜Ğ Ğ˜ Ğ¢ĞĞ¢ Ğ–Ğ• connection?
    // ğŸ’­ SqlConnection - thread-safe Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚?
    // ğŸ’­ ĞœĞ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ connection Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾?
    //
    // ğŸ¤” ĞŸĞ¾Ğ´ÑƒĞ¼Ğ°Ğ¹ Ğ¿Ñ€Ğ¾ _results.Add(result) Ğ²Ğ½Ğ¸Ğ·Ñƒ:
    // â“ Ğ•ÑĞ»Ğ¸ 10 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Add()... ÑÑ‚Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾?
    // â“ ĞšĞ°ĞºĞ¾Ğ¹ Ñ‚Ğ¸Ğ¿ Ñƒ _results? (Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ 16)
    // ğŸ’­ ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ ConcurrentBag, Ğ° Ğ½Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ List?
    //
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private static async Task ExecuteQueryAsync(
        SqlConnection connection,
        string queryTemplate,
        int accountId,
        int threadId,
        ConcurrentBag<TestResult> results,
        CancellationToken cancellationToken)
    {
        var stopwatch = Stopwatch.StartNew();
        var result = new TestResult
        {
            AccountId = accountId,
            ThreadId = threadId,
            Timestamp = DateTime.UtcNow
        };

        try
        {
            var query = ReplacePercentMarkers(queryTemplate, accountId);

            // â“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ SqlCommand Ñ connection Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°...
            // ğŸ’­ Ğ•ÑĞ»Ğ¸ Ğ´Ğ²Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ´ÑƒÑ‚ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ñ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ connection?
            // ğŸ’­ ĞœĞ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ connection Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ²Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾?
            await using var command = new SqlCommand(query, connection)
            {
                CommandTimeout = 30
            };

            // â“ Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ·Ğ´ĞµÑÑŒ Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ?
            // ğŸ’­ ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ? Ğ˜Ğ»Ğ¸ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ Ğ¸ Ğ¶Ğ´Ñ‘Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ Ğ‘Ğ”?
            // ğŸ’­ ĞŸĞ¾ĞºĞ° ÑÑ‚Ğ¾Ñ‚ await Ğ¶Ğ´Ñ‘Ñ‚... Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ»Ğ¸ Ğ”Ğ Ğ£Ğ“Ğ˜Ğ• Task Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ?
            await using var reader = await command.ExecuteReaderAsync(cancellationToken);

            while (await reader.ReadAsync(cancellationToken))
            {

            }

            stopwatch.Stop();
            result.ExecutionTimeMs = stopwatch.Elapsed.TotalMilliseconds;
            result.IsError = false;
        }
        catch (Exception ex)
        {
            stopwatch.Stop();
            result.ExecutionTimeMs = stopwatch.Elapsed.TotalMilliseconds;
            result.IsError = true;
            result.ErrorMessage = ex.Message;
        }

        // â“ ConcurrentBag - Ğ·Ğ°Ñ‡ĞµĞ¼? Ğ§ĞµĞ¼ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚ List<T>?
        // ğŸ’­ Ğ§Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚, ĞµÑĞ»Ğ¸ 10 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²ÑƒÑ‚ Add()?
        results.Add(result);
    }

    private static int GetMaxPercentMarkerValue(string query)
    {
        int maxPercentCount = 0;
        int currentPercentCount = 0;

        foreach (var ch in query)
        {
            if (ch == '%')
            {
                currentPercentCount++;
                maxPercentCount = Math.Max(maxPercentCount, currentPercentCount);
            }
            else
            {
                currentPercentCount = 0;
            }
        }

        return maxPercentCount > 0 ? (int)Math.Pow(10, maxPercentCount) : 1;
    }

    private static string ReplacePercentMarkers(string query, int counter)
    {
        return Regex.Replace(query, "%+", match =>
        {
            var percentCount = match.Value.Length;
            var maxValue = (int)Math.Pow(10, percentCount);
            var value = counter % maxValue;

            return value.ToString($"D{percentCount}");
        });
    }
}
