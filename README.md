# SQL Performance Tester

Утилита для нагрузочного тестирования SQL Server баз данных с возможностью одновременного выполнения до 50+ асинхронных запросов.

## Возможности

- Асинхронное выполнение множественных SQL-запросов с контролем количества потоков
- Гибкая подстановка счетчиков через маски `%` с настраиваемым количеством разрядов
  - `%` - от 0 до 9 (1 разряд)
  - `%%` - от 00 до 99 (2 разряда)
  - `%%%` - от 000 до 999 (3 разряда) и т.д.
- Поддержка нескольких масок в одном запросе
- Экспорт результатов в CSV-файл для детального анализа
- Статистика по завершении теста (всего запросов, ошибки, среднее время)
- Аварийная остановка тестирования
- Обработка ошибок и reconnect при обрывах соединения

## Запуск приложения

```bash
cd SqlPerformanceTester
dotnet run
```

Или запустите скомпилированный exe-файл из папки `bin\Debug\net6.0-windows\`

## Использование

### Параметры тестирования

1. **Сервер** - адрес SQL Server (например: `localhost`, `192.168.1.100`, `server.domain.com`)
2. **БД** - имя базы данных для подключения
3. **Запрос** - SQL-запрос с опциональными масками `%`, где количество символов `%` определяет диапазон:
   ```sql
   -- Однозначные числа (0-9)
   SELECT * FROM AccountView WHERE AccountId = %

   -- Двузначные числа (00-99)
   SELECT * FROM MeterTable WHERE MeterId = 'П00489%%6'

   -- Трехзначные числа (000-999)
   SELECT * FROM Table WHERE Code = '%%%'

   -- Несколько масок разной длины
   SELECT * FROM Relations WHERE ParentId = %% AND ChildId = %%%

   -- Без маски (холостая нагрузка)
   SELECT * FROM SystemInfo WHERE Id = 1
   ```
4. **Количество потоков** - количество одновременных запросов (1-150, рекомендуется 50)
5. **Время тестирования** - длительность теста в секундах
6. **Результат (файл)** - путь к CSV-файлу для сохранения результатов

### Процесс тестирования

1. Заполните все параметры подключения и тестирования
2. Нажмите кнопку **Старт**
3. Дождитесь завершения теста (кнопка **Старт** станет активной)
4. Для досрочной остановки нажмите **Стоп**
5. После завершения появится окно с результатами и автоматически сохранится CSV-файл

### Формат CSV-файла результатов

```csv
ExecutionTimeMs,ID,ThreadId,Timestamp,IsError,ErrorMessage
125.543,1,12,2026-01-30T10:30:15.123,False,
134.221,2,8,2026-01-30T10:30:15.456,False,
1500.000,5,15,2026-01-30T10:30:16.789,True,"Timeout expired"
```

Поля:
- **ExecutionTimeMs** - время выполнения запроса в миллисекундах
- **ID** - ID лицевого счета (0-99)
- **ThreadId** - идентификатор потока
- **Timestamp** - время выполнения запроса
- **IsError** - флаг ошибки
- **ErrorMessage** - текст ошибки (если есть)

## Сценарии использования масок %

### Гибкая система масок
Количество символов `%` определяет диапазон чисел:

#### Один символ `%` (0-9)
```sql
SELECT * FROM Accounts WHERE AccountId = %
-- Запросы: WHERE AccountId = 0, 1, 2, ..., 9
```
Подходит для: небольших тестовых наборов данных (10 записей)

#### Два символа `%%` (00-99)
```sql
SELECT * FROM HCSMETERTABLE WHERE METERID = 'П00489%%6'
-- Запросы: METERID = 'П004890006', 'П004890106', ..., 'П004899906'
```
Подходит для: имитации нагрузки от 100 пользователей/счетов

#### Три символа `%%%` (000-999)
```sql
SELECT * FROM Orders WHERE OrderId = %%%
-- Запросы: WHERE OrderId = 000, 001, 002, ..., 999
```
Подходит для: тестирования на 1000 записях

#### Четыре и более символов `%%%%` (0000-9999+)
```sql
SELECT * FROM BigTable WHERE Code = '%%%%'
-- Запросы: WHERE Code = '0000', '0001', ..., '9999'
```
Подходит для: больших наборов данных (10000+ записей)

### Несколько масок разной длины
Можно использовать несколько масок с разным количеством разрядов в одном запросе:
```sql
-- Разные диапазоны для разных полей
SELECT * FROM Relations WHERE ParentId = %% AND ChildId = %%%
-- При счетчике = 42: ParentId = 42 AND ChildId = 042
-- При счетчике = 1234: ParentId = 34 AND ChildId = 234

-- В составных ключах
INSERT INTO Log (UserId, DayId, RecordId) VALUES (%%, %, %%%%)
```

### Без маски (холостая нагрузка)
Запрос без `%` выполняется без изменений:
```sql
SELECT * FROM SystemInfo WHERE Id = 1
SELECT COUNT(*) FROM LargeTable
```
Полезно для:
- Проверки кэширования БД
- Тестирования производительности конкретного запроса
- Нагрузки на "горячую" запись

### Примеры счетчика

| Счетчик | `%` | `%%` | `%%%` | `%%%%` |
|---------|-----|------|-------|--------|
| 0       | 0   | 00   | 000   | 0000   |
| 7       | 7   | 07   | 007   | 0007   |
| 42      | 2   | 42   | 042   | 0042   |
| 123     | 3   | 23   | 123   | 0123   |
| 9999    | 9   | 99   | 999   | 9999   |
| 10000   | 0   | 00   | 000   | 0000   |

## Рекомендации по тестированию

### Базовый тест
- Потоков: 50
- Длительность: 300 секунд (5 минут)
- Цель: оценка производительности при целевой нагрузке

### Стресс-тест
- Потоков: 70-100
- Длительность: 600 секунд (10 минут)
- Цель: определение максимальной пропускной способности

### Тест в период реальной нагрузки
- Время запуска: 2:00-7:00 утра
- Потоков: 50
- Цель: оценка производительности в условиях реальной нагрузки ЛК

### Комбинированные тесты
- Запуск одновременно с нагрузкой CPU/памяти БД
- Запуск во время перестроения материализованных представлений

## Анализ результатов

### Итоговое окно после завершения:
После завершения теста появится окно с результатами:
- Всего запросов
- Успешных запросов
- Количество ошибок
- Среднее время выполнения
- Путь к сохраненному CSV-файлу

### CSV-файл можно импортировать в:
- Excel/LibreOffice Calc для построения графиков
- Power BI для детального анализа
- Python/R для статистической обработки

## Безопасность

- Утилита выполняет ТОЛЬКО SELECT-запросы
- Используется Windows Authentication (Integrated Security)
- TrustServerCertificate включен для локальных тестов
- Таймаут запроса: 30 секунд

## Устранение неполадок

### Ошибка подключения
- Проверьте доступность SQL Server
- Убедитесь, что у вас есть права доступа к БД
- Проверьте настройки брандмауэра

### Низкая производительность
- Уменьшите количество потоков
- Проверьте индексы в БД
- Проверьте нагрузку на SQL Server

### Ошибки таймаута
- Увеличьте таймаут в коде (по умолчанию 30 сек)
- Оптимизируйте SQL-запрос
- Проверьте план выполнения запроса в SQL Server

## Архитектура

- **UI**: WPF (Windows Presentation Foundation)
- **Многопоточность**: SemaphoreSlim + Task Parallel Library
- **БД**: Microsoft.Data.SqlClient 6.1.4
- **Паттерн**: Code-behind (для простоты утилиты)

## Лицензия

Внутренний проект для тестирования производительности БД.
